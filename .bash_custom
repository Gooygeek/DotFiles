######  INIT  ######

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

shopt -s expand_aliases

# Easy way to reload the Bash Config
alias rebash='source ~/.bashrc'

######  ENV  ######

# env {{{{{{

PATH="$PATH:$HOME/.local/bin"
PATH="$PATH:/usr/local/go/bin" # If Golang is installed

# Set the default editor to vim.
export EDITOR=vim
export VISUAL=vim

# Set the location of the .inputrc file
#export INPUTRC=~/.inputrc

# Text Colours and Effects
# Effects
RESET_EFFECTS='\[\e[0m\]'
BOLD='\[\e[1m\]'
#BLINK='\[\e[5m\]'
# Normal Colours
BLACK='\[\e[30m\]'
RED='\[\e[31m\]'
GREEN='\[\e[32m\]'
YELLOW='\[\e[33m\]'
BLUE='\[\e[34m\]'
MAGENTA='\[\e[35m\]'
CYAN='\[\e[36m\]'
LIGHTGRAY='\[\e[37m\]'
# Equal to Normal colours with the Bold Effect
DARKGREY='\[\e[90m\]'
LIGHTRED='\[\e[91m\]'
LIGHTGREEN='\[\e[92m\]'
LIGHTYELLOW='\[\e[93m\]'
LIGHTBLUE='\[\e[94m\]'
LIGHTMAGENTA='\[\e[95m\]'
LIGHTCYAN='\[\e[96m\]'
WHITE='\[\e[97m\]'
# }}}}}}

######  MISC. ALIAS  ######

# Aliases {{{
# Allows Aliases to be expanded when using a bare sudo <command>
alias sudo='sudo '

# Terraform and Terragrunt
alias tf='terraform'
alias tg='terragrunt'

# Curl sends back 3XX errors be default, '-L' means it will automatically follow the redirect.
alias curl='curl -L'

# ensure tmux used 256 colours
alias tmux='tmux -2'
alias t='tmux -2'
# alias tm='tmux -2' # See the .bash.d folder for a better script
alias tml='tmux list-sessions'
alias tmk='tmux kill-session -t'

# small git shortcut
alias g='git'
alias lg='lazygit'

# Python
if which python3 > /dev/null 2>&1; then
    alias py='python3'
else
    alias py='python'
fi

# vim
alias v='vim'

# Quick way to make something execuatable
alias exe='chmod u+x'

# Alias's for making archives
alias mktar='tar -cvf'
alias mkbz2='tar -cvjf'
alias mkgz='tar -cvzf'

# Check which ports are open
alias openports='netstat -plntae --inet'

# Kubectl
alias k='kubectl'
alias kg='kubectl get'
alias kga='kubectl get all'
alias kgaa='kubectl get all --all-namespaces'
alias klf='kubectl logs --tail=200  -f'
alias kgs='kubectl get service -o wide'
alias kgd='kubectl get deployment -o wide'
alias kgp='kubectl get pod -o wide'
alias kgn='kubectl get node -o wide'
alias kdp='kubectl describe pod'
alias kds='kubectl describe service'
alias kdd='kubectl describe deployment'
alias kdf='kubectl delete -f'
alias kaf='kubectl apply -f'
alias kci='kubectl cluster-info'
alias kgc='kubectl config get-contexts'
alias ksc='kubectl config set-context'
alias awsk8='aws eks update-kubeconfig --name'
alias kexec='kubectl exec -it'

# }}}

######  MISC. FUNCTIONS  ######

# Functions {{{

for file in ~/.bash.d/*; do
    . $file
done

# Note that some of the alias' point to these functions

# }}}

######  BASH  ######

# Bash {{{

# Autocomplete for bash
if [ -f /etc/bash_completion ]; then
  . /etc/bash_completion
elif [ -f /opt/local/etc/profile.d/bash_completion.sh ]; then
  . /opt/local/etc/profile.d/bash_completion.sh
fi

# Case insensitive when performing filename expansion
shopt -s nocaseglob

# If set, the pattern "**" used in a pathname expansion context will
# match all files and zero or more directories and subdirectories.
#shopt -s globstar

# History expansion takes place after a space rather than on command execution
bind '" ":magic-space'

# Multi-line commands are saved to the history with embedded newlines rather than using semicolon separators where possible
shopt -s lithist

# Don't put duplicate lines in the history and do not add lines that start with a space
export HISTCONTROL=erasedups:ignoredups:ignorespace

# Don't add to the history The commands (match exactly):
# 	- &
# 	- ls
# 	- fg
# 	- bg
# 	- exit
# 	- [Starts with a space]
# 	- [Starts with a tab]
export HISTIGNORE="&:ls:[bf]g:exit:[ ]*"

# Large History size
export HISTSIZE=99999

# Append commands to the bash command history file (~/.bash_history) instead of overwriting it.
shopt -s histappend

# Append commands to the history every time a prompt is shown, instead of after closing the session.
PROMPT_COMMAND='history -a'

# }}}

######  Bash Prompt  ######

# prompt {{{

# Better prompt (with git AND python venv support)
export GIT_PS1_SHOWDIRTYSTATE=true
export export GIT_PS1_SHOWSTASHSTATE=true
declare -F | grep __git_ps1 > /dev/null
if [ "$?" -eq 0 ]; then
  export PS1=" \n${LIGHTBLUE}[\W]${LIGHTMAGENTA}\$(__py_venv)${LIGHTRED}\$(__git_ps1 '(%s)') ${LIGHTGREEN}ʃ${RESET_EFFECTS} "
else
  export PS1=" \n${LIGHTBLUE}[\W] ${GREEN}${BOLD}ʃ${RESET_EFFECTS} "
fi

# Multiline promt
export PS2="» "
# Potential prompt symbols
# $
# §
# ¦
# ¬
# ʃ
# ˧
# »

if command -v starship >/dev/null 2>&1; then
  eval "$(starship init bash)"
fi

# }}}

######  CD  ######

# cd {{{

# If set, minor errors in the spelling of a directory component in a cd command will be corrected. The errors checked for are transposed characters, a missing character, and a character too many. If a correction is found, the corrected path is printed, and the command proceeds.
shopt -s cdspell

# Tab-completion only shows directories
complete -d cd

# Moves up a specified number of directories
cdup() { cd $(eval printf '../'%.0s {1..$1}) && pwd; }

# CDPATH is like the path for cd directories. Default is just '.'
export CDPATH=.:~

# }}}

######  ls  ######

# ls {{{

# List dir with:
# 	- Almost all
# 	- Colour
# 	- Filetype
# 	- Horizonal
alias ls='ls -AF --format=horizontal --color=auto'

# List dir with:
# 	- Long format
# 	- Almost all
# 	- Sorted by time (recents at the bottom)
# 	- Human readable filesize
# 	- Nicer timestamp
alias lls='ls -AFltrh --time-style long-iso --color=auto'

# }}}

######  vi  ######

# vi {{{

# Save a copy of the file before oopening it in vi
function safevi() {
  cp  ${1} ${1}.$(date +"%Y%m%d-%H%M%S")
  vi ${1}
}
# }}}

###### ssh ######

# SSH {{{

# Start the agent on login
if [ -z "$SSH_AUTH_SOCK" ] ; then
  eval `ssh-agent -s`
fi

# }}}

###### git ######

# Git {{{

# Adopt new push behaviour and don't show message about it not being set
git config --global push.default simple

# }}}

###### gpg ######

# GPG {{{

export GPG_TTY=$(tty)

# }}}

######  fd  ######

# fd {{{

if command -v fd >/dev/null 2>&1; then
  alias find='fd'
  fd_default_command_options="--hidden --follow --ignore-file ~/.config/fd/ignore"
  alias fd="fd $fd_default_command_options"
fi

# }}}

######  fzf  ######

# fzf {{{

# Kuberenetes bash autocomplete
[ -f ~/.fzf.bash ] && source ~/.fzf.bash
if command -v fzf >/dev/null 2>&1; then
  # Display at the top of the screen
  # Toggle preview window visibility with '?'
  # Select all entries with 'CTRL-A'
  # Copy the selected entries to the clipboard with 'CTRL-Y'
  # Open the selected entries in vim with 'CTRL-E'
  # Open the selected entries in vscode with 'CTRL-V'
  export FZF_DEFAULT_OPTS="
    --layout=reverse
    --info=inline
    --height=70%
    --prompt='∼ ' --pointer='▶'
    --color='hl:148,hl+:154,pointer:#a1efe4,marker:010,bg+:#383830,bg:#272822'

    --multi --marker='✓'

    --preview-window=:hidden
    --preview '([[ -f {} ]] && (bat --style=numbers --color=always {} || cat {})) || ([[ -d {} ]] && (tree -C {} | less)) || echo {} 2> /dev/null | head -200'

    --bind '?:toggle-preview'
    --bind 'ctrl-a:select-all'
    --bind 'ctrl-y:execute-silent(echo {+} | pbcopy)'
    --bind 'ctrl-e:execute(echo {+} | xargs -o vim)'
    --bind 'ctrl-v:execute(code {+})'
    "
fi

# If fd is installed, use that over the find command
if command -v fd >/dev/null 2>&1; then
  # Show hidden files, follow links
  export FZF_DEFAULT_COMMAND="\fd $fd_default_command_options"
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
  export FZF_ALT_C_COMMAND="$FZF_DEFAULT_COMMAND --type d"
  _fzf_compgen_path() {
      fd . "$1"
  }
  _fzf_compgen_dir() {
      fd --type d . "$1"
  }
fi

_fzf_setup_completion path ag git kubectl lls

# }}}

######  Terraform  ######

# tf {{{

# Add tfenv to the PATH
export PATH="$HOME/.tfenv/bin:$PATH"

# }}}

######  Kuberenetes  ######

# k8 {{{

# Kuberenetes bash autocomplete
if command -v kubectl >/dev/null 2>&1; then
  source <(kubectl completion bash)
  complete -F __start_kubectl k
fi

# }}}

######  OTHER  ######

# Other {{{

# 'ESC+.' will insert the last commands last argument. Same as 'ALT+.'. Looks to be the same as what '!$' is expanded to
bind '"\e.": yank-last-arg'

# Make sure left and right arrow keys work correctly (default)
bind '"\e[C": forward-char'
bind '"\e[D": backward-char'

# Up and Down arrow will search the history, filtering on the command currently typed
bind '"\e[A":history-search-backward'
bind '"\e[B":history-search-forward'

# SHIFT+TAB will cycle through tab completion options
bind '"\e[Z":menu-complete'

# Redirect '>' will not overwrite existing files
# Can be forced with '>!'
set -o noclobber

# When tab-completing, tab will complete until the ambiguity. Often an additional tab is required to then show the possibilities. This setting means it will show the possibilities immediately. (Not woorking)
#bind "set show-all-if-ambiguous on"

# Disable the auditory tone aka bell
bind "set bell-style visible"
bind "set prefer-visible-bell"

# Disable XON/XOFF control flow i.e. Ctrl-s wont hang the terminal (if it does, use Ctrl-q to resume)
stty -ixon

# Check the window size after each command and, if necessary,
#   update the values of LINES and COLUMNS.
shopt -s checkwinsize

# }}}


# OPTIONAL

# Awesome command prompt
# . ~/.bash_prompt_advanced

# Short Prompt
# . ~/.bash_prompt_short

######  TEST SECTION  ######


# config for this file only
# vim:foldmethod=marker:foldlevel=0:foldminlines=0
